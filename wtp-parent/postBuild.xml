<?xml version="1.0" encoding="UTF-8"?>
<project default="post-build">
	<taskdef resource="net/sf/antcontrib/antlib.xml" />

	<target name="init" 
		description="Setup of variables and prepare the files to be processed">
		<!-- 
		We need to process the Hudson variables (those like [env.***] to make it meaningful for us (WTP), 
		more details about the Hudson variables in [https://hudson.eclipse.org/webtools/env-vars.html]
		
		1) We need to remove the "-", replace the "_" with "-" and remove the last 2 digits (seconds) from the timestamp.
		Thanks to the regex's magic we only group yyyy-mm-dd_hh-mm-ss and and tranform into: yyyymmdd_hhmm.
		-->
		<propertyregex 
			property="build.id" 
			input="${env.BUILD_ID}" 
			regexp="(\d{4})-(\d{2})-(\d{2})_(\d{2})-(\d{2})(-\d{2})" 
			replace="\1\2\3\4\5" 
			casesensitive="false" />
		
		<!--
		2) We need the WTP version generated, we will get it from the repository file; from there we strip out
		from the irrelevant information (path, qualifier, etc.) and get only the wtp.version
		-->
		<path id="repo.path">
			<fileset dir="./webtools.repositories/repository/target/">
				<include name="repository-*.zip" />
			</fileset>
		</path>
		<property name = "repo.id" refid = "repo.path"/>
		<propertyregex 
			property="wtp.version"
			input="${repo.id}"
			regexp=".*repository-(.*)-v.*.zip"
			select="\1"
			casesensitive="false" />
		
		<!-- 
		Next, we are going to generate the path for the new build
		This is compound by:
		1) The download mount point [/home/data/httpd/download.eclipse.org]
		2) The webtools dir segment [/webtools/downloads/cbi]
		3) The wtp version segment: [/wtp4x-RX.Y.Z-I]
		2) The timestamp dir
		-->
		<property name = "eclipse.download" value="/home/data/httpd/download.eclipse.org" />
		<property name = "build.path" 
			value = "/home/data/httpd/download.eclipse.org/webtools/downloads/cbi/wtp4x-R${wtp.version}-I/${build.id}"/>
		
		
		<!--
		Displaying the values to be used for the post-processing
		-->
		<echo message="download.eclipse.org Directory: 	[${eclipse.download}]" />
		<echo message="WTP Download Directory: 			[${build.path}]" />	
		<echo message="Build ID:						[${build.id}]" />			
		<echo message="WTP Version:						[${wtp.version}]" />
				
	</target>

	<target name="copy-files" 
		depends="init" 
		description="Copies the artifacts generated by the build and the JUnit Result Reports to the the Download Machine">
		<echo message="Moving artifacts..." />
		<!--First we copy all the *.zip files from the targets, this mean the artifacts generated by maven-->
		<copy todir="${build.path}" flatten="true">
			<fileset dir="../">
				<patternset id="wtp-artifacts">
					<include name="webtools.repositories/*/target/*.zip" />
				</patternset>
			</fileset>
		</copy>
		<echo message="Moving JUnit Reports" />
		<!--Second we copy all the *.xml with the surefire-reports-->
		<copy todir="${build.path}" flatten="true">
			<fileset dir="../">
				<patternset id="junit-reports">
					<include name="**/target/surefire-reports/*.xml" />
				</patternset>
			</fileset>
		</copy>
	</target>

	<target name="post-build" depends="copy-files">

	</target>
</project>